<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Caltr</title>
    <style type="text/css">
      html {
        height: 100%;
      }
      body {
        font: 8pt monospace;
        height: 100%;
      }
      table {
        border-collapse:collapse;
      }
      td {
        border: 1px solid;
        vertical-align: right;
      }
      #map_canvas {
       width:75%;
       height:100%;
       float:left;
      }
    </style>
    <script src="jquery-1.7.2.min.js"></script>
    <script src="date.js"></script>
    <script src="moment.js"></script>
    <script src="trainList2.js"></script>
    <script src="caltr.js"></script>
    <script src="waypoints2.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?sensor=false&libraries=geometry"></script>
    <script>
       

        function showStops(){
            $.each(waypoints, function(i, wp){
              if(wp.hasOwnProperty('stop')){
                  var p = new google.maps.LatLng(wp.lat, wp.lng); 
                  new google.maps.Marker({
                    position: p,
                    map: map,
                    title: wp.stop + ' ' + wp.name
                  });
              }
            });
        }
        function runNewTrains(trains){
         trains.forEach(function(train){
             var t = new caltr.ActiveTrain({
                 trainTimes: train,
                 waypoints: waypoints2
             });
             t.run();
             //train.activeTrain = t; //this sucks but need for remove?
             activeTrains.push(train);
         });
        }
        var trainTuples = [
        { trainTimes: trains,
          waypoints: waypoints2}
        ];
        var activeTrains = [];
        //var newTrains = [];
      $(document).ready(function(){
        caltr.config.mapCanvas = $('#map_canvas')[0];
        caltr.core.init();
        caltr.utils.startDate = moment(Date.parse('2012-08-10 17:05:30'));
        caltr.core.createDateObjects(trains);
        caltr.core.createWpObjects(waypoints2.waypoints);
        //newTrains = caltr.core.getNewTrains(trainTuples, activeTrains, now);
        setInterval(function(){
         var now = caltr.utils.fakeNow();//TODO
         var newTrains = caltr.core.getNewTrains(trainTuples, activeTrains, now);
         if(newTrains.length){
           console.log('ntr', newTrains);
           runNewTrains(newTrains);
         } 
        }, 10000);
      });
    </script>
  </head>
  <body>
   <div id="map_canvas"></div> 
  </body>
</html>
