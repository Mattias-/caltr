<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Caltr</title>
    <style type="text/css">
      html {
        height: 100%;
      }
      body {
        font: 8pt monospace;
        height: 100%;
      }
      table {
        border-collapse:collapse;
      }
      td {
        border: 1px solid;
        vertical-align: right;
      }
      #map_canvas {
        width:75%;
        height:100%;
        float:left;
      }
    </style>
    <script src="static/jquery-1.7.2.min.js"></script>
    <script src="static/date.js"></script>
    <script src="static/moment.js"></script>
    <script src="static/config.js"></script>
    <script src="static/core.js"></script>
    <script src="static/caltr.js"></script>
    <!--<script src="static/waypoints2.js"></script>-->
    <script src="https://maps.googleapis.com/maps/api/js?sensor=false&libraries=geometry"></script>
    <script>
//    function showStops(){
//        $.each(waypoints, function(i, wp){
//          if(wp.hasOwnProperty('stop')){
//              var p = new google.maps.LatLng(wp.lat, wp.lng); 
//              new google.maps.Marker({
//                position: p,
//                map: map,
//                title: wp.stop + ' ' + wp.name
//              });
//          }
//        });
//    }
      $(document).ready(function(){
        caltr.trainTuples = [];
        caltr.allTrains = [];
        caltr.utils.startDate = moment(Date.parse('2012-08-10 17:05:30'));
        var now = caltr.utils.fakeNow();//TODO
        var url = "data/"+now.getTime()+"/south"
        $.ajax(url, {dataType: "json"}).done(function(r){
          console.log(r);
          caltr.core.createDateObjects(r.trains);
          caltr.core.createWpObjects(r.waypoints.waypoints);
          r.trains.forEach(function(train){
            caltr.allTrains.push({
              stops: train.stops,
              number: train.number,
              waypoints: r.waypoints
            });
          });
        }).fail(function(f){
          console.log('failed', f);
        });
        caltr.activeTrains = [];

        caltr.mapCanvas = $('#map_canvas')[0];
        caltr.core.init();
        //var now = caltr.utils.fakeNow();//TODO
        //var newTrains = caltr.core.getNewTrains(caltr.trainTuples,
        //                                        caltr.activeTrains, now);
        //caltr.core.runNewTrains(newTrains.slice(1,2));
        setInterval(function(){
          var now = caltr.utils.fakeNow();//TODO
          var newTrains = caltr.core.getNewTrains(caltr.allTrains,
                                                  caltr.activeTrains, now);
          if(newTrains.length){
            console.log('ntr', newTrains);
            caltr.core.runNewTrains(newTrains);
          } 
        }, 10000);
      });
    </script>
  </head>
  <body>
    <div id="map_canvas"></div> 
  </body>
</html>
